<div class="dashboard-container">

  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="header-left">
        <h1>Dashboard</h1>
        <p class="subtitle">{{ isOnline() ? 'Ready for orders' : 'You are offline' }}</p>
      </div>

      <button (click)="toggleStatus()" class="status-toggle" [class.online]="isOnline()" [class.offline]="!isOnline()">
        <span class="status-indicator"></span>
        <span class="status-text">{{ isOnline() ? 'Online' : 'Offline' }}</span>
      </button>
    </div>
  </header>

  <!-- Message Toast -->
  <div *ngIf="message()" class="toast-notification">
    <span class="toast-icon">ğŸ””</span>
    <span class="toast-text">{{ message() }}</span>
  </div>

  <main class="main-content">

    <!-- Offline State -->
    <div *ngIf="!isOnline()" class="offline-state">
      <div class="offline-icon">ğŸ˜´</div>
      <h2>You're Offline</h2>
      <p>Go online to start earning. We'll notify you when new orders arrive nearby.</p>
      <button (click)="toggleStatus()" class="btn-primary btn-large">Go Online</button>
    </div>

    <!-- Online Dashboard -->
    <div *ngIf="isOnline()" class="online-dashboard">

      <!-- New Requests Tab -->
      <div *ngIf="activeTab() === 'requests'" class="tab-content">
        <div class="section-header">
          <h2>New Requests</h2>
          <span class="badge-blue">{{ requests().length }} nearby</span>
        </div>

        <div *ngIf="requests().length === 0" class="empty-state">
          <div class="radar-icon">ğŸ“¡</div>
          <p class="primary-text">Scanning area...</p>
          <p class="secondary-text">Stay in high demand areas to get more orders.</p>
          <div class="scanning-bar">
            <div class="scanning-line"></div>
          </div>
        </div>

        <div class="requests-list">
          <div *ngFor="let req of requests()" class="request-card">
            <div class="card-header">
              <div class="restaurant-info">
                <h3>{{ req.restaurantName }}</h3>
                <div class="meta-info">
                  <span>ğŸ“ 2.5 km</span> â€¢ <span>Fast Food</span>
                </div>
              </div>
              <div class="earnings-badge">
                <span class="label">Earn</span>
                <span class="amount">â‚¹{{ req.earnings }}</span>
              </div>
            </div>

            <div class="trip-details">
              <div class="detail-item">
                <span class="label">Trip</span>
                <span class="value">5.0 km</span>
              </div>
              <div class="separator"></div>
              <div class="detail-item">
                <span class="label">Est. Time</span>
                <span class="value">25 min</span>
              </div>
            </div>

            <div class="card-actions">
              <button (click)="rejectOrder(req.assignmentId)" class="btn-secondary">Decline</button>
              <button (click)="acceptOrder(req.assignmentId)" class="btn-primary">Accept</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Active Order Tab -->
      <div *ngIf="activeTab() === 'active'" class="tab-content full-height">
        <div *ngIf="!currentOrder()" class="empty-state bordered">
          <div class="icon">ğŸ“¦</div>
          <h3>No Active Order</h3>
          <p>Check requests or wait for new ones.</p>
        </div>

        <div *ngIf="currentOrder()" class="active-order-card">
          <!-- Status Banner -->
          <div class="status-banner">
            <div class="banner-content">
              <p class="label">Current Status</p>
              <h2>{{ currentOrder().status.replace('_', ' ') }}</h2>
              <p class="order-id">Order #{{ currentOrder().orderId }}</p>
            </div>
          </div>

          <!-- Map Container -->
          <div class="map-wrapper">
            <app-map [showMarker]="false" (mapReady)="onMapReady()"></app-map>
          </div>

          <!-- Actions Sheet -->
          <div class="action-sheet">
            <div class="drag-handle"></div>

            <!-- Stepper -->
            <div class="stepper">
              <!-- Re-use existing stepper code... -->
              <div class="step">
                <div class="step-circle completed">âœ“</div>
                <span class="step-label">Picked</span>
              </div>
              <div class="step-line">
                <div class="progress"
                  [style.width.%]="currentOrder().status === 'PICKED_UP' || currentOrder().status === 'DELIVERED' ? 100 : 0">
                </div>
              </div>
              <div class="step">
                <div class="step-circle"
                  [class.completed]="currentOrder().status === 'PICKED_UP' || currentOrder().status === 'DELIVERED'">
                  {{ currentOrder().status === 'PICKED_UP' || currentOrder().status === 'DELIVERED' ? 'âœ“' : '2' }}
                </div>
                <span class="step-label">On Way</span>
              </div>
              <div class="step-line">
                <div class="progress" [style.width.%]="currentOrder().status === 'DELIVERED' ? 100 : 0"></div>
              </div>
              <div class="step">
                <div class="step-circle" [class.completed]="currentOrder().status === 'DELIVERED'">
                  {{ currentOrder().status === 'DELIVERED' ? 'âœ“' : '3' }}
                </div>
                <span class="step-label">Drop</span>
              </div>
            </div>

            <!-- COD Alert -->
            <div *ngIf="currentOrder().paymentMethod === 'COD'" class="cod-alert" 
                style="background: #ffebee; color: #c62828; padding: 12px; margin: 10px 0; border-radius: 8px; text-align: center; font-weight: bold; border: 1px solid #ef9a9a;">
                ğŸ’° Cash to Collect: â‚¹{{ currentOrder().totalAmount }}
            </div>

            <div class="sheet-buttons">
              <button *ngIf="currentOrder().status === 'ASSIGNED_TO_RIDER'" (click)="markPickedUp()"
                class="btn-primary btn-block icon-btn">
                <span>Confirm Pickup</span> â¡ï¸
              </button>
              <button *ngIf="currentOrder().status === 'PICKED_UP'" (click)="markDelivered()"
                class="btn-success btn-block icon-btn">
                <span>Confirm Delivery</span> âœ…
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- History Tab -->
      <div *ngIf="activeTab() === 'history'" class="tab-content">
        <h2 class="section-title">Past Deliveries</h2>
        <div *ngIf="history().length === 0" class="empty-state small">
          No history yet. Start driving! ğŸš—
        </div>
        <div class="history-list">
          <div *ngFor="let h of history()" class="history-item">
            <div class="history-left">
              <div class="order-icon">#{{ h.orderId.substring(0,4) }}</div>
              <div class="order-meta">
                <p class="date">{{ h.deliveredAt | date:'mediumDate' }}</p>
                <p class="status">Delivered</p>
              </div>
            </div>
            <div class="history-right">
              <p class="earning-amount">+â‚¹{{ h.earning }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Earnings Tab -->
      <div *ngIf="activeTab() === 'earnings'" class="tab-content">
        <h2 class="section-title">Earnings Wallet</h2>

        <!-- Total Card -->
        <!-- Total Card -->
        <div *ngIf="earnings()" class="wallet-card">
          <div class="wallet-background"></div>
          <p class="label">Net Payable (Payout)</p>
          <h1 class="balance">â‚¹{{ earnings().netPayable | number:'1.2-2' }}</h1>

          <div class="wallet-details">
            <div class="detail">
              <p class="label">Total Earnings</p>
              <p class="value" style="color:#2ecc71">+â‚¹{{ earnings().totalEarnings }}</p>
            </div>
            <div class="detail">
              <p class="label">Cash Collected</p>
              <p class="value" style="color:#e74c3c">-â‚¹{{ earnings().cashCollected }}</p>
            </div>
          </div>
        </div>

        <!-- Recent Transactions -->
        <div class="transactions-card">
          <div class="card-header-row">
            <h3>Recent Payouts</h3>
            <button class="link-btn">See All</button>
          </div>
          <div class="transaction-list">
            <div class="transaction-item">
              <div class="trans-left">
                <div class="trans-icon">ğŸ¦</div>
                <div>
                  <p class="trans-title">Bank Transfer</p>
                  <p class="trans-date">Yesterday</p>
                </div>
              </div>
              <span class="trans-amount">-â‚¹1,250</span>
            </div>
            <div class="transaction-item faded">
              <div class="trans-left">
                <div class="trans-icon">ğŸ¦</div>
                <div>
                  <p class="trans-title">Bank Transfer</p>
                  <p class="trans-date">Tue, 12 Oct</p>
                </div>
              </div>
              <span class="trans-amount">-â‚¹850</span>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Incoming Assignment Modal -->
    <div *ngIf="incomingRequest()" class="modal-overlay">
      <div class="modal-content animate-slide-up">

        <div class="modal-header">
          <div class="pulse-bg"></div>
          <div class="modal-icon">ğŸ›µ</div>
          <h2>New Order Request</h2>
          <p>{{ incomingRequest().restaurantName }}</p>
        </div>

        <div class="modal-body">
          <div class="earnings-highlight">
            <span class="amount">â‚¹{{ incomingRequest().earnings | number:'1.0-0' }}</span>
            <span class="badge-green">High Demand ğŸ”¥</span>
          </div>

          <div class="stats-grid">
            <div class="stat-box">
              <p class="label">Distance</p>
              <p class="value">{{ incomingRequest().distanceKm | number:'1.1-1' }} km</p>
            </div>
            <div class="stat-box">
              <p class="label">ETA</p>
              <p class="value">{{ incomingRequest().eta }} min</p>
            </div>
          </div>

          <!-- Countdown -->
          <div class="countdown-container">
            <div class="countdown-labels">
              <span>Accept within</span>
              <span class="time">{{ timeLeft() }}s</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="(timeLeft() / 25) * 100"></div>
            </div>
          </div>

          <div class="modal-actions">
            <button (click)="rejectIncoming()" class="btn-secondary btn-large">Decline</button>
            <button (click)="acceptIncoming()" class="btn-primary btn-large shadow">Accept Order</button>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- Bottom Navigation Bar -->
  <nav *ngIf="isOnline()" class="bottom-nav">
    <button (click)="setTab('requests')" class="nav-item" [class.active]="activeTab() === 'requests'">
      <div class="nav-icon">
        ğŸ 
        <span *ngIf="requests().length" class="dot-indicator"></span>
      </div>
      <span class="nav-label">Home</span>
    </button>

    <button (click)="setTab('active')" class="nav-item" [class.active]="activeTab() === 'active'">
      <div class="nav-icon">
        ğŸ›µ
        <span *ngIf="currentOrder()" class="dot-indicator green animate-ping"></span>
      </div>
      <span class="nav-label">Active</span>
    </button>

    <button (click)="setTab('earnings')" class="nav-item" [class.active]="activeTab() === 'earnings'">
      <div class="nav-icon">ğŸ’³</div>
      <span class="nav-label">Wallet</span>
    </button>

    <button (click)="setTab('history')" class="nav-item" [class.active]="activeTab() === 'history'">
      <div class="nav-icon">ğŸ“œ</div>
      <span class="nav-label">History</span>
    </button>
  </nav>

</div>